<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical Acronym Search</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom scrollbar for results */
      #results::-webkit-scrollbar {
        width: 8px;
      }
      #results::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      #results::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      #results::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Header collapse animation */
      #header {
        max-height: 300px;
        opacity: 1;
        margin-top: 1rem;
        margin-bottom: 1.5rem;
        overflow: hidden;
        transition:
          max-height 0.15s ease,
          opacity 0.1s ease,
          margin-top 0.15s ease,
          margin-bottom 0.15s ease;
      }

      #header.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        margin-bottom: 0;
      }

      /* Footer fade animation */
      #footer {
        transition: opacity 0.1s ease;
      }

      #footer.collapsed {
        /* opacity: 0; */
      }

      @media (prefers-reduced-motion: reduce) {
        #header,
        #footer {
          transition: none;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 h-screen flex flex-col">
    <div class="max-w-2xl mx-auto w-full flex flex-col h-full p-4">
      <!-- Header -->
      <div id="header" class="flex-none h-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          Medical Acronym Lookup
        </h1>
        <p class="text-gray-600">
          Clinical abbreviations, primarily sourced from the NSW Government
          South Eastern Sydney Local Health District, document
          <a
            href="https://www.seslhd.health.nsw.gov.au/policies-and-publications/functional-group/71"
            class="text-blue-500 underline"
            >SESLHDPR/282</a
          >.
        </p>
      </div>

      <!-- Search Input -->
      <div class="flex-none mb-4">
        <input
          id="search"
          type="text"
          placeholder="Type an acronym (e.g., AA, CMP, ICU)..."
          autocomplete="off"
          autocorrect="off"
          spellcheck="false"
          autocapitalize="off"
          autofocus
          class="w-full text-lg p-4 border-2 border-blue-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 shadow-sm"
        />
      </div>

      <!-- Results Container -->
      <div id="results" class="flex-1 overflow-y-auto space-y-2"></div>

      <!-- Footer -->
      <div id="footer" class="flex-none text-center text-sm text-gray-500 p-2">
        <p>Type an acronym to search â€¢ Results update as you type</p>
      </div>
    </div>

    <script>
      // Acronym data injected at build time
      const acronyms = {{ACRONYM_DATA}};

      // Get DOM elements
      const searchInput = document.getElementById('search');
      const resultsContainer = document.getElementById('results');
      const header = document.getElementById('header');
      const footer = document.getElementById('footer');

      // Header collapse state
      let headerCollapsed = false;
      function setHeaderCollapsed(collapsed) {
        if (collapsed === headerCollapsed) return;
        headerCollapsed = collapsed;
        if (collapsed) {
          header.classList.add('collapsed');
          footer.classList.add('collapsed');
        } else {
          header.classList.remove('collapsed');
          footer.classList.remove('collapsed');
        }
      }

      // Debounce function to limit search frequency
      let debounceTimer;
      function debounce(func, delay) {
        return function(...args) {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => func.apply(this, args), delay);
        };
      }

      // Search function
      function search(query) {
        // Clear results if query is empty
        if (!query || query.trim() === '') {
          resultsContainer.innerHTML = '';
          return;
        }

        const normalizedQuery = query.toUpperCase().trim();
        const queryLower = query.toLowerCase().trim();
        const isLongQuery = queryLower.length >= 4;
        const results = [];
        const matchedAcronyms = new Set();

        // PASS 1: Search acronyms (always)
        for (const [acronym, meanings] of Object.entries(acronyms)) {
          const normalizedAcronym = acronym.toUpperCase();

          // Prefix match on acronym
          if (normalizedAcronym.startsWith(normalizedQuery)) {
            const isExact = normalizedAcronym === normalizedQuery;
            results.push({
              acronym: acronym,
              meanings: meanings,
              // sortKey: [matchTypePriority, matchPosition, length, uppercase]
              sortKey: [
                isExact ? 0 : 1,  // 0=exact, 1=prefix
                0,                 // matchPosition (not used for acronym matches)
                acronym.length,
                acronym.toUpperCase()
              ]
            });
            matchedAcronyms.add(acronym);
          }

          // Limit to 50 results for performance
          if (results.length >= 50) break;
        }

        // PASS 2: Search meanings (only if query >= 4 chars and < 50 results)
        if (isLongQuery && results.length < 50) {
          for (const [acronym, meanings] of Object.entries(acronyms)) {
            // Skip already matched acronyms
            if (matchedAcronyms.has(acronym)) continue;

            // Search through all meanings for this acronym
            let bestMatchType = null;
            let bestMatchPosition = Infinity;

            for (const meaningObj of meanings) {
              const meaningLower = meaningObj.meaning.toLowerCase();
              const matchIndex = meaningLower.indexOf(queryLower);

              if (matchIndex !== -1) {
                // Check if match is at word boundary
                const isWordStart = matchIndex === 0 || /[\s-]/.test(meaningLower[matchIndex - 1]);
                const matchType = isWordStart ? 2 : 3;  // 2=word-start, 3=substring

                // Track the best match for this acronym
                if (bestMatchType === null || matchType < bestMatchType ||
                    (matchType === bestMatchType && matchIndex < bestMatchPosition)) {
                  bestMatchType = matchType;
                  bestMatchPosition = matchIndex;
                }
              }
            }

            // If we found a match in meanings, add the result
            if (bestMatchType !== null) {
              results.push({
                acronym: acronym,
                meanings: meanings,
                sortKey: [
                  bestMatchType,      // 2=word-start, 3=substring
                  bestMatchPosition,  // Earlier matches first
                  acronym.length,
                  acronym.toUpperCase()
                ]
              });
              matchedAcronyms.add(acronym);

              // Limit to 50 results for performance
              if (results.length >= 50) break;
            }
          }
        }

        // Sort results by priority
        results.sort((a, b) => {
          // Match type priority (0=exact, 1=prefix, 2=word-start, 3=substring)
          if (a.sortKey[0] !== b.sortKey[0]) return a.sortKey[0] - b.sortKey[0];
          // Match position (earlier first, for meaning matches)
          if (a.sortKey[1] !== b.sortKey[1]) return a.sortKey[1] - b.sortKey[1];
          // Length (shorter first)
          if (a.sortKey[2] !== b.sortKey[2]) return a.sortKey[2] - b.sortKey[2];
          // Alphabetically
          return a.sortKey[3].localeCompare(b.sortKey[3]);
        });

        // Render results
        renderResults(results);
      }

      // Render results to DOM
      function renderResults(results) {
        if (results.length === 0) {
          // <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 text-center">
          resultsContainer.innerHTML = `
            <div class="p-6 text-center">
              <p class="text-gray-600">No acronyms found matching your search.</p>
            </div>
          `;
          return;
        }

        const html = results.map(result => {
          const meaningsHtml = result.meanings.map(m => `
            <div class="mb-1 last:mb-0">
              <p class="text-gray-700">${escapeHtml(m.meaning)}</p>
              ${m.note ? `<p class="text-sm text-gray-500 italic mt-1">${escapeHtml(m.note)}</p>` : ''}
            </div>
          `).join('');

          return `
            <div class="bg-white p-2 rounded-md shadow-xs border border-gray-200 hover:shadow-sm transition-shadow">
              <div class="text-lg font-bold text-blue-600 mb-1">${escapeHtml(result.acronym)}</div>
              ${meaningsHtml}
            </div>
          `;
        }).join('');

        resultsContainer.innerHTML = html;
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Event listener with debouncing
      const debouncedSearch = debounce((value) => search(value), 50);

      searchInput.addEventListener('input', (e) => {
        setHeaderCollapsed(e.target.value.trim().length > 0);
        debouncedSearch(e.target.value);
      });

      // Initial search if there's a value (e.g., from browser autocomplete)
      if (searchInput.value) {
        setHeaderCollapsed(true);
        search(searchInput.value);
      }
    </script>
  </body>
</html>
